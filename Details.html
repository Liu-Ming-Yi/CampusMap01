<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>空間詳細資料與平面圖</title>
    <link rel="icon" href="TCUMAP/logo.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* 核心變數同步 */
        :root {
            --tech-blue: #007bff;
            --neon-glow: rgba(0, 123, 255, 0.5);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --bg-color: #f0f2f5;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 20px; 
            background-color: var(--bg-color); 
            color: #2c3e50; 
            display: flex; justify-content: center;
        }

        .container { 
            max-width: 900px; width: 100%; 
            background: var(--glass-bg); 
            backdrop-filter: blur(15px);
            padding: 30px; 
            border-radius: 16px; 
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }

        /* 標題與返回按鈕 */
        .header-container { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 25px;
        }
        h1 { 
            color: #1a202c; margin: 0; font-size: 1.6rem; 
            letter-spacing: 1px; border-left: 5px solid var(--tech-blue); padding-left: 15px;
        }
        
        #back-button { 
            padding: 10px 20px; font-size: 0.9rem; 
            background: #1a202c; color: #00f2fe; 
            border: 1px solid rgba(0, 242, 254, 0.3); border-radius: 8px; 
            text-decoration: none; font-weight: 600;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
        }
        #back-button:hover { 
            background: var(--tech-blue); color: white; 
            box-shadow: 0 0 15px var(--neon-glow); transform: translateX(-5px);
        }

        /* 詳細資料列表 */
        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }

        .detail-item { 
            display: flex; flex-direction: column; gap: 5px;
            background: rgba(255,255,255,0.5); padding: 15px; border-radius: 10px;
            border: 1px solid #edf2f7; transition: 0.3s;
        }
        .detail-item:hover { border-color: var(--tech-blue); background: #fff; }

        .detail-label { font-weight: 700; font-size: 0.8rem; color: #718096; text-transform: uppercase; }
        .detail-value { font-size: 1.1rem; color: #2d3748; }

        /* 圖片容器：霓虹發光效果 */
        #image-container { 
            text-align: center; margin-top: 30px; min-height: 300px; 
            background-color: #1a202c; /* 深色底襯托平面圖 */
            display: flex; align-items: center; justify-content: center; 
            border-radius: 12px; position: relative; overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            border: 2px solid #2d3748;
        }

        /* 掃描線動畫效果 */
        #image-container::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 242, 254, 0.2);
            animation: scan 3s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        #image-zoom-wrapper { cursor: zoom-in; width: 100%; padding: 10px; box-sizing: border-box; }
        
        #space-image { 
            max-width: 100%; height: auto; display: block; margin: 0 auto;
            border-radius: 4px; transition: transform 0.3s;
            filter: drop-shadow(0 0 10px rgba(0, 242, 254, 0.3));
        }

        #img-status { color: #718096; font-size: 0.9rem; }

        /* 全螢幕燈箱 */
        .fullscreen-overlay { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: rgba(10, 14, 23, 0.95); z-index: 999; 
            display: flex; justify-content: center; align-items: center; cursor: zoom-out; 
            backdrop-filter: blur(5px);
        }
        .zoomed-image { max-width: 95vw; max-height: 95vh; object-fit: contain; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 id="detail-title">LOADING...</h1>
            <a id="back-button" href="index.html">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                BACK TO LIST
            </a> 
        </div>

        <div id="details-content">
            <div class="info-grid">
                <div class="detail-item">
                    <span class="detail-label">Campus 校區</span>
                    <span id="campus-name" class="detail-value">---</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Space ID 編號</span>
                    <span id="space-no" class="detail-value">---</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Space Name 名稱</span>
                    <span id="space-name" class="detail-value">---</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Location 樓棟/樓層</span>
                    <span id="location-text" class="detail-value">---</span>
                </div>
            </div>

            <div id="image-container">
                <div id="image-zoom-wrapper">
                    <span id="img-status">Initializing Scanner...</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="./config.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        const CAMPUS_MAP = { '1': '中央校區', '2': '介仁校區', '3': '建國校區' };
        const BUILDING_NAMES_MAP = {
            "1": { "A": "和敬樓 A 棟", "B": "和敬樓 B 棟", "C": "和敬樓 C 棟", "D": "勤耕樓 D 棟", "E": "勤耕樓 E 棟", "F": "大捨樓 F 棟", "H": "福田樓 H 棟", "L": "大愛樓 L 棟", "T": "大喜館 L 棟" },
            "2": { "A": "合心樓 2A 棟", "B": "文心樓 2B 棟", "C": "立心樓 2C 棟", "D": "知心樓 2D 棟", "E": "明心樓 2E 棟", "G": "體育館 2A 棟", "H": "活動中心 2A 棟" }
        };

        function getParam(n) { return new URLSearchParams(window.location.search).get(n); }

        function enableImageZoom(img) {
            const o = document.createElement('div'); o.className = 'fullscreen-overlay';
            img.onclick = () => {
                document.body.appendChild(o);
                const z = img.cloneNode(); z.className = 'zoomed-image';
                o.innerHTML = ''; o.appendChild(z);
            };
            o.onclick = () => o.remove();
        }

        function tryLoadImage(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(url);
                img.onerror = () => resolve(null);
                img.src = url;
            });
        }

        async function loadAndDisplayImage(picNo, spaceName) {
            const wrap = document.getElementById("image-zoom-wrapper");
            if (!picNo || picNo === "null") { wrap.innerHTML = "<span style='color:#718096'>NO MAP DATA</span>"; return; }
            
            const exts = ['png', 'jpg', 'jpeg'];
            let valid = null;
            
            for (const ext of exts) {
                valid = await tryLoadImage(`TCUMAP/${picNo}.${ext}`);
                if (valid) break;
            }
            if (!valid && spaceName) {
                for (const ext of exts) {
                    valid = await tryLoadImage(`TCUMAP/${spaceName}.${ext}`);
                    if (valid) break;
                }
            }

            if (valid) {
                const img = new Image(); img.id = "space-image"; img.src = valid;
                img.onload = () => { 
                    wrap.innerHTML = ""; wrap.appendChild(img); 
                    enableImageZoom(img); 
                };
            } else { wrap.innerHTML = "<span style='color:#e53e3e'>MAP NOT FOUND</span>"; }
        }

        function renderDetails(data) {
            const kw = getParam('keyword') || "", sID = getParam('sID') || "";
            document.getElementById("back-button").href = `index.html?keyword=${encodeURIComponent(kw)}&highlightID=${encodeURIComponent(sID)}`;
            
            document.getElementById("detail-title").textContent = (data.SpaceName || "SPACE DETAIL").toUpperCase();
            document.getElementById("space-name").textContent = data.SpaceName;
            document.getElementById("campus-name").textContent = CAMPUS_MAP[data.CampusNo] || data.CampusNo;
            document.getElementById("space-no").textContent = data.SpaceNo;
            
            const bMap = BUILDING_NAMES_MAP[data.CampusNo];
            const bName = bMap ? (bMap[data.BuildingNo] || bMap[data.BuildingNo.replace(/^2/,'')] || `${data.BuildingNo} 棟`) : (data.BuildingNo ? `${data.BuildingNo} 棟` : "");
            const fName = data.FloorNo ? `${data.FloorNo} 樓` : "";
            document.getElementById("location-text").textContent = `${bName} / ${fName}`;

            let pic = String(data.PicNo || "");
            if (pic.includes("E+") || pic.includes(".")) pic = data.SpaceName;
            loadAndDisplayImage(pic, data.SpaceName);
        }

        async function load() {
            const sID = getParam('sID');
            if (!sID) return;
            const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data } = await client.from("TblSpace").select("*").eq("sID", sID).maybeSingle();
            if (data) renderDetails(data);
        }
        window.onload = load;
    </script>
</body>
</html>
