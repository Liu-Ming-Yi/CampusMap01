<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Á©∫ÈñìË≥áË®äÊü•Ë©¢Á≥ªÁµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
        .main-content-wrapper { max-width: 100%; padding: 0 20px; margin: 20px auto; }
        
        /* Ê®ôÈ°åËàáÁµ±Ë®àÂçÄÂ°ä */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-bar h1 { font-size: 1.5rem; margin: 0; color: #333; }

        /* Áµ±Ë®àÊï∏ÊìöÊ®ôÁ±§ÁµÑ */
        .stats-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .stat-tag {
            background-color: #fff;
            color: #555;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .online-dot {
            width: 8px; height: 8px; background-color: #28a745;
            border-radius: 50%; margin-right: 6px;
            box-shadow: 0 0 5px #28a745;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* ÊêúÂ∞ãÂàó */
        .search-bar { margin: 10px 0 20px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-bar select, .search-bar input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; }
        .search-bar input { flex-grow: 1; min-width: 200px; }
        .search-bar button { padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: #fff; cursor: pointer; transition: 0.2s; }
        .search-bar button:hover { background-color: #0056b3; }

        /* Ë°®Ê†ºÊ®£Âºè */
        .table-container { width: 100%; overflow-x: auto; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); border-radius: 4px; }
        table { width: 100%; min-width: 800px; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 12px 10px; font-size: 0.9rem; text-align: center; border-bottom: 1px solid #eee; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { cursor: pointer; background: #555; color: #fff; position: relative; }
        
        .sort-indicator { display: inline-flex; flex-direction: column; vertical-align: middle; margin-left: 5px; line-height: 0.7; }
        .sort-arrow { color: rgba(255, 255, 255, 0.2); font-size: 0.7rem; }
        .active-asc .arrow-up { color: #8ac0ff !important; }
        .active-desc .arrow-down { color: #8ac0ff !important; }

        .highlight-row, .highlight-row td { background-color: #fff9c4 !important; font-weight: bold; }
        td a { color: #007bff; text-decoration: none; font-weight: 600; }

        .floating-header-container { position: fixed; top: 0; z-index: 100; overflow: hidden; background-color: #555; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #back-to-top { display: none; position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; background: #007bff; color: #fff; border-radius: 50%; text-align: center; line-height: 45px; text-decoration: none; z-index: 1000; }
    </style>
</head>
<body>

    <div class="main-content-wrapper">
        <div class="header-bar">
            <h1>Á©∫ÈñìË≥áË®äÊü•Ë©¢Á≥ªÁµ±</h1>
            <div class="stats-group">
                <div class="stat-tag"><span class="online-dot"></span>Âú®Á∑öÔºö<span id="online-count">1</span></div>
                <div class="stat-tag">ÈÅäË¶Ω‰∫∫Êï∏Ôºö<span id="visitor-count">...</span></div>
                <div class="stat-tag">ÁÄèË¶ΩÊ¨°Êï∏Ôºö<span id="visit-total">...</span></div>
            </div>
        </div>

        <div id="status">ÁãÄÊÖãÔºöËºâÂÖ•‰∏≠...</div>
        <div id="error" style="color: red; margin: 10px 0;"></div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="ÊêúÂ∞ãÂêçÁ®±„ÄÅÁ∑®Ëôü..." />
            <button id="search-btn">ÊêúÂ∞ã</button>
            <select id="campus-filter"></select>
            <select id="building-filter"></select>
            <button id="reset-btn" style="display:none; background-color: #6c757d;">ÈáçË®≠</button>
        </div>

        <div class="table-container" id="table-container">
            <table id="space-table">
                <thead><tr id="table-head-row"></tr></thead>
                <tbody id="space-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="floating-header-container" id="floating-header-container">
        <table id="floating-header-table"><thead><tr id="floating-header-row"></tr></thead></table>
    </div>
    
    <a id="back-to-top" href="#">üîù</a>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BUILDING_NAMES_MAP = {
                "1": { "A": "ÂíåÊï¨Ê®ì A Ê£ü", "B": "ÂíåÊï¨Ê®ì B Ê£ü", "C": "ÂíåÊï¨Ê®ì C Ê£ü", "D": "Âã§ËÄïÊ®ì D Ê£ü", "E": "Âã§ËÄïÊ®ì E Ê£ü", "F": "Â§ßÊç®Ê®ì F Ê£ü", "H": "Á¶èÁî∞Ê®ì H Ê£ü", "L": "Â§ßÊÑõÊ®ì L Ê£ü", "T": "Â§ßÂñúÈ§® L Ê£ü" },
                "2": { "A": "ÂêàÂøÉÊ®ì 2A Ê£ü", "B": "ÊñáÂøÉÊ®ì 2B Ê£ü", "C": "Á´ãÂøÉÊ®ì 2C Ê£ü", "D": "Áü•ÂøÉÊ®ì 2D Ê£ü", "E": "ÊòéÂøÉÊ®ì 2E Ê£ü", "G": "È´îËÇ≤È§® 2A Ê£ü", "H": "Ê¥ªÂãï‰∏≠ÂøÉ 2A Ê£ü" }
            };

            const app = {
                supabase: null,
                currentData: [],
                sortCol: 'SpaceNo', sortDir: 1,
                CAMPUS_MAP: { '1': '‰∏≠Â§ÆÊ†°ÂçÄ', '2': '‰ªã‰ªÅÊ†°ÂçÄ', '3': 'Âª∫ÂúãÊ†°ÂçÄ' },
                COLS: ['SpaceNo', 'SpaceName', 'CampusNo', 'BuildingNo', 'FloorNo', 'PicNo'],
                COL_NAMES: { 'SpaceNo': 'Á©∫ÈñìÁ∑®Ëôü', 'SpaceName': 'Á©∫ÈñìÂêçÁ®±', 'CampusNo': 'Ê†°ÂçÄ', 'BuildingNo': 'Ê®ìÊ£ü', 'FloorNo': 'Ê®ìÂ±§', 'PicNo': 'ÂúñÁâáÁ∑®Ëôü' },

                async init() {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.setupStats();
                    this.setupRealtime();
                    this.renderFilters();
                    this.bindEvents();
                    this.loadFromURL();
                },

                // 1. Âú®Á∑ö‰∫∫Êï∏ (Presence)
                async setupRealtime() {
                    const channel = this.supabase.channel('online_tracking', {
                        config: { presence: { key: 'user' } }
                    });
                    channel
                        .on('presence', { event: 'sync' }, () => {
                            const state = channel.presenceState();
                            document.getElementById('online-count').textContent = Object.keys(state).length;
                        })
                        .subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') await channel.track({ online_at: new Date().toISOString() });
                        });
                },

                // 2. Áµ±Ë®àÊï∏Êìö (ÂÑ™ÂåñÁâàÔºöÂÖàÊü•ÂæåÂØ´ÔºåÈÅøÂÖç 409 ÈåØË™§)
                async setupStats() {
                    try {
                        const ipRes = await fetch('https://api.ipify.org?format=json');
                        const { ip } = await ipRes.json();
                        const today = new Date().toISOString().split('T')[0];

                        // ÂÖàÊ™¢Êü•‰ªäÂ§©ÊúâÊ≤íÊúâÈÄôÁ≠Ü IP
                        const { data: existing } = await this.supabase
                            .from('daily_page_views')
                            .select('id')
                            .eq('ip_address', ip)
                            .eq('view_date', today)
                            .maybeSingle();

                        if (!existing) {
                            await this.supabase.from('daily_page_views').insert([{ ip_address: ip }]);
                            console.log("‰ªäÊó•È¶ñÊ¨°Ë®™ÂïèÔºåÁ¥ÄÈåÑÂ∑≤ÂÑ≤Â≠ò„ÄÇ");
                        } else {
                            console.log("‰ªäÊó•Â∑≤Á¥ÄÈåÑÈÅéÔºåË∑≥ÈÅéÈáçË§áÂØ´ÂÖ•„ÄÇ");
                        }

                        // ÊäìÂèñÂÖ®Ë°®Ë®àÁÆóÈ°ØÁ§∫Êï∏Â≠ó
                        const { data } = await this.supabase.from('daily_page_views').select('ip_address');
                        if (data) {
                            document.getElementById('visit-total').textContent = data.length;
                            const uniqueIPs = new Set(data.map(item => item.ip_address));
                            document.getElementById('visitor-count').textContent = uniqueIPs.size;
                        }
                    } catch (err) { console.error('Stats Error:', err); }
                },

                renderFilters() {
                    let cOpt = '<option value="">-- Ê†°ÂçÄ --</option>';
                    Object.entries(this.CAMPUS_MAP).forEach(([k, v]) => cOpt += `<option value="${k}">${v}</option>`);
                    document.getElementById('campus-filter').innerHTML = cOpt;
                    let bOpt = '<option value="">-- Ê®ìÊ£ü --</option>';
                    for (let i = 65; i <= 90; i++) bOpt += `<option value="${String.fromCharCode(i)}">${String.fromCharCode(i)} Ê£ü</option>`;
                    document.getElementById('building-filter').innerHTML = bOpt;
                },

                bindEvents() {
                    document.getElementById('search-btn').onclick = () => this.fetchData(document.getElementById('search-input').value);
                    document.getElementById('reset-btn').onclick = () => window.location.href = window.location.pathname;
                    document.getElementById('campus-filter').onchange = () => this.fetchData(document.getElementById('search-input').value);
                    document.getElementById('building-filter').onchange = () => this.fetchData(document.getElementById('search-input').value);

                    const handleHeaderClick = (e) => {
                        const th = e.target.closest('th');
                        if (th) {
                            this.sortDir = (this.sortCol === th.dataset.col) ? this.sortDir * -1 : 1;
                            this.sortCol = th.dataset.col;
                            this.sortAndRender();
                        }
                    };
                    document.getElementById("table-head-row").onclick = handleHeaderClick;
                    document.getElementById("floating-header-row").onclick = handleHeaderClick;

                    window.onscroll = () => {
                        const table = document.getElementById("space-table");
                        const floating = document.getElementById("floating-header-container");
                        const rect = table.getBoundingClientRect();
                        const container = document.getElementById("table-container");
                        if (rect.top < 0 && rect.bottom > 100) {
                            floating.style.display = "block";
                            floating.style.width = container.offsetWidth + "px";
                            floating.style.left = container.getBoundingClientRect().left + "px";
                        } else {
                            floating.style.display = "none";
                        }
                        document.getElementById("back-to-top").style.display = window.scrollY > 300 ? "block" : "none";
                    };
                },

                async fetchData(kw = "", hID = null) {
                    document.getElementById('status').textContent = "ÁãÄÊÖã: Ê™¢Á¥¢‰∏≠...";
                    const camp = document.getElementById('campus-filter').value;
                    const bld = document.getElementById('building-filter').value;

                    let q = this.supabase.from("TblSpace").select('*');
                    if (kw) q = q.or(`SpaceName.ilike.%${kw}%,SpaceNo.ilike.%${kw}%`);
                    if (camp) q = q.eq('CampusNo', camp);
                    if (bld) q = q.or(`BuildingNo.eq.${bld},BuildingNo.eq.2${bld}`);

                    const { data, error } = await q.limit(1000);
                    if (error) { document.getElementById('error').textContent = error.message; return; }
                    this.currentData = data || [];
                    document.getElementById('status').textContent = `ÁãÄÊÖã: ÊâæÂà∞ ${this.currentData.length} Á≠ÜË≥áÊñô`;
                    this.sortAndRender(hID);
                },

                sortAndRender(hID) {
                    this.currentData.sort((a, b) => {
                        let vA = String(a[this.sortCol] || "");
                        let vB = String(b[this.sortCol] || "");
                        return vA.localeCompare(vB, undefined, { numeric: true }) * this.sortDir;
                    });
                    this.render(hID);
                },

                render(hID) {
                    const hHTML = this.COLS.map(c => `
                        <th data-col="${c}">${this.COL_NAMES[c]}
                            <span class="sort-indicator ${this.sortCol === c ? (this.sortDir === 1 ? 'active-asc' : 'active-desc') : ''}">
                                <span class="sort-arrow arrow-up">‚ñ¥</span><span class="sort-arrow arrow-down">‚ñæ</span>
                            </span>
                        </th>`).join('');
                    document.getElementById("table-head-row").innerHTML = hHTML;
                    document.getElementById("floating-header-row").innerHTML = hHTML;

                    document.getElementById("space-tbody").innerHTML = this.currentData.map(row => `
                        <tr class="${hID && String(row.sID) === String(hID) ? 'highlight-row' : ''}">
                            ${this.COLS.map(c => {
                                let v = row[c] || "";
                                if (c === 'CampusNo') v = this.CAMPUS_MAP[v] || v;
                                if (c === 'BuildingNo') {
                                    const campusMap = BUILDING_NAMES_MAP[row.CampusNo];
                                    if (campusMap) {
                                        const cleanNo = v.toString().replace(/^2/, '');
                                        v = campusMap[v] || campusMap[cleanNo] || `${v} Ê£ü`;
                                    }
                                }
                                if (c === 'SpaceName' && row.PicNo) return `<td><a href="Details.html?sID=${row.sID}">${v}</a></td>`;
                                return `<td>${v}</td>`;
                            }).join('')}
                        </tr>`).join('');
                    document.getElementById('reset-btn').style.display = 'inline-block';
                },

                loadFromURL() {
                    const p = new URLSearchParams(window.location.search);
                    document.getElementById('search-input').value = p.get('keyword') || "";
                    this.fetchData(p.get('keyword') || "", p.get('highlightID'));
                }
            };
            app.init();
        });
    </script>
</body>
</html>

