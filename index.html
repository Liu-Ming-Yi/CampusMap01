<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>TCU MAP QUERY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
        .main-content-wrapper { max-width: 100%; padding: 0 20px; margin: 20px auto; }
        
        /* Ê®ôÈ°åËàáÁµ±Ë®àÂàó */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-bar h1 { font-size: 1.5rem; margin: 0; color: #333; }

        /* Áµ±Ë®àÊ®ôÁ±§Ê®£Âºè */
        .stats-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .stat-tag {
            background-color: #fff;
            color: #555;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .online-dot {
            width: 8px; height: 8px; background-color: #28a745;
            border-radius: 50%; margin-right: 6px;
            box-shadow: 0 0 5px #28a745;
        }

        /* ÊêúÂ∞ãËàáÈÅéÊøæ */
        .search-bar { margin: 10px 0 20px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-bar select, .search-bar input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .search-bar input { flex-grow: 1; min-width: 200px; }
        .search-bar button { padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: #fff; cursor: pointer; }

        /* Ë°®Ê†ºËàáÊéíÂ∫èÁ¨¶Ëôü */
        .table-container { width: 100%; overflow-x: auto; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        table { width: 100%; min-width: 800px; border-collapse: collapse; }
        th, td { padding: 12px 10px; font-size: 0.9rem; text-align: center; border-bottom: 1px solid #eee; }
        th { cursor: pointer; background: #555; color: #fff; }
        .sort-indicator { display: inline-flex; flex-direction: column; vertical-align: middle; margin-left: 4px; }
        .sort-arrow { color: rgba(255, 255, 255, 0.2); font-size: 0.7rem; line-height: 0.6; }
        .active-asc .arrow-up { color: #8ac0ff !important; }
        .active-desc .arrow-down { color: #8ac0ff !important; }

        .floating-header-container { position: fixed; top: 0; z-index: 100; overflow: hidden; background-color: #555; display: none; }
        #back-to-top { display: none; position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; background: #007bff; color: #fff; border-radius: 50%; text-align: center; line-height: 45px; text-decoration: none; }
    </style>
</head>
<body>

    <div class="main-content-wrapper">
        <div class="header-bar">
            <h1>Á©∫ÈñìË≥áË®äÊü•Ë©¢Á≥ªÁµ±</h1>
            <div class="stats-group">
                <div class="stat-tag"><span class="online-dot"></span>Âú®Á∑öÔºö<span id="online-count">1</span></div>
                <div class="stat-tag">ÈÅäË¶Ω‰∫∫Êï∏Ôºö<span id="visitor-count">...</span></div>
                <div class="stat-tag">ÁÄèË¶ΩÊ¨°Êï∏Ôºö<span id="visit-total">...</span></div>
            </div>
        </div>

        <div id="status">ÁãÄÊÖãÔºöËºâÂÖ•‰∏≠...</div>
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="ÊêúÂ∞ãÂêçÁ®±ÊàñÁ∑®Ëôü..." />
            <button id="search-btn">ÊêúÂ∞ã</button>
            <select id="campus-filter"></select>
            <select id="building-filter"></select>
            <button id="reset-btn" style="display:none;">ÈáçË®≠</button>
        </div>

        <div class="table-container" id="table-container">
            <table id="space-table">
                <thead><tr id="table-head-row"></tr></thead>
                <tbody id="space-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="floating-header-container" id="floating-header-container">
        <table id="floating-header-table"><thead><tr id="floating-header-row"></tr></thead></table>
    </div>
    <a id="back-to-top" href="#">üîù</a>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                supabase: null,
                currentData: [],
                sortCol: 'SpaceNo', sortDir: 1,
                CAMPUS_MAP: { '1': '‰∏≠Â§ÆÊ†°ÂçÄ', '2': '‰ªã‰ªÅÊ†°ÂçÄ', '3': 'Âª∫ÂúãÊ†°ÂçÄ' },
                COLS: ['SpaceNo', 'SpaceName', 'CampusNo', 'BuildingNo', 'FloorNo', 'PicNo'],
                COL_NAMES: { 'SpaceNo': 'Á©∫ÈñìÁ∑®Ëôü', 'SpaceName': 'Á©∫ÈñìÂêçÁ®±', 'CampusNo': 'Ê†°ÂçÄ', 'BuildingNo': 'Ê®ìÊ£ü', 'FloorNo': 'Ê®ìÂ±§', 'PicNo': 'ÂúñÁâáÁ∑®Ëôü' },

                async init() {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.setupStats();
                    this.setupRealtime();
                    this.renderFilters();
                    this.bindEvents();
                    this.loadFromURL();
                },

                // 1. Âú®Á∑ö‰∫∫Êï∏Áõ£Êéß (Realtime Presence)
                async setupRealtime() {
                    const channel = this.supabase.channel('room_1');
                    channel
                        .on('presence', { event: 'sync' }, () => {
                            const state = channel.presenceState();
                            document.getElementById('online-count').textContent = Object.keys(state).length;
                        })
                        .subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') {
                                await channel.track({ online_at: new Date().toISOString() });
                            }
                        });
                },

                // 2. ÁÄèË¶ΩËàáÈÅäË¶Ω‰∫∫Êï∏Áµ±Ë®à
                async setupStats() {
                    try {
                        const ipRes = await fetch('https://api.ipify.org?format=json');
                        const { ip } = await ipRes.json();
                        // ÂØ´ÂÖ•Á¥ÄÈåÑ
                        await this.supabase.from('daily_page_views').insert([{ ip_address: ip }]);

                        // ÊäìÂèñÊâÄÊúâÁ¥ÄÈåÑ‰ª•Ë®àÁÆó„ÄåÁ∏ΩÊ¨°Êï∏„ÄçËàá„Äå‰∏çÈáçË§á‰∫∫Êï∏„Äç
                        const { data } = await this.supabase.from('daily_page_views').select('ip_address');
                        if (data) {
                            document.getElementById('visit-total').textContent = data.length;
                            const uniqueIPs = new Set(data.map(item => item.ip_address));
                            document.getElementById('visitor-count').textContent = uniqueIPs.size;
                        }
                    } catch (err) { console.error('Stats fail', err); }
                },

                renderFilters() {
                    let cOpt = '<option value="">-- Ê†°ÂçÄ --</option>';
                    Object.entries(this.CAMPUS_MAP).forEach(([k, v]) => cOpt += `<option value="${k}">${v}</option>`);
                    document.getElementById('campus-filter').innerHTML = cOpt;
                    let bOpt = '<option value="">-- Ê®ìÊ£ü --</option>';
                    for (let i = 65; i <= 90; i++) bOpt += `<option value="${String.fromCharCode(i)}">${String.fromCharCode(i)} Ê£ü</option>`;
                    document.getElementById('building-filter').innerHTML = bOpt;
                },

                bindEvents() {
                    document.getElementById('search-btn').onclick = () => this.fetchData(document.getElementById('search-input').value);
                    document.getElementById('reset-btn').onclick = () => window.location.href = window.location.pathname;
                    const handleHeaderClick = (e) => {
                        const th = e.target.closest('th');
                        if (th) {
                            this.sortDir = (this.sortCol === th.dataset.col) ? this.sortDir * -1 : 1;
                            this.sortCol = th.dataset.col;
                            this.sortAndRender();
                        }
                    };
                    document.getElementById("table-head-row").onclick = handleHeaderClick;
                    document.getElementById("floating-header-row").onclick = handleHeaderClick;
                    window.onscroll = () => {
                        const table = document.getElementById("space-table");
                        const floating = document.getElementById("floating-header-container");
                        const rect = table.getBoundingClientRect();
                        floating.style.display = (rect.top < 0 && rect.bottom > 100) ? "block" : "none";
                        floating.style.width = table.offsetWidth + "px";
                        floating.style.left = table.getBoundingClientRect().left + "px";
                    };
                },

                async fetchData(kw = "", hID = null) {
                    document.getElementById('status').textContent = "ÁãÄÊÖã: Ê™¢Á¥¢‰∏≠...";
                    let q = this.supabase.from("TblSpace").select('*');
                    if (kw) q = q.or(`SpaceName.ilike.%${kw}%,SpaceNo.ilike.%${kw}%`);
                    const { data, error } = await q.limit(1000);
                    if (error) return;
                    this.currentData = data || [];
                    document.getElementById('status').textContent = `ÁãÄÊÖã: ÊâæÂà∞ ${this.currentData.length} Á≠Ü`;
                    this.sortAndRender(hID);
                },

                sortAndRender(hID) {
                    this.currentData.sort((a, b) => (String(a[this.sortCol])).localeCompare(String(b[this.sortCol]), undefined, {numeric: true}) * this.sortDir);
                    this.render(hID);
                },

                render(hID) {
                    const hHTML = this.COLS.map(c => `
                        <th data-col="${c}">${this.COL_NAMES[c]}
                            <span class="sort-indicator ${this.sortCol === c ? (this.sortDir === 1 ? 'active-asc' : 'active-desc') : ''}">
                                <span class="sort-arrow arrow-up">‚ñ¥</span><span class="sort-arrow arrow-down">‚ñæ</span>
                            </span>
                        </th>`).join('');
                    document.getElementById("table-head-row").innerHTML = hHTML;
                    document.getElementById("floating-header-row").innerHTML = hHTML;

                    document.getElementById("space-tbody").innerHTML = this.currentData.map(row => `
                        <tr class="${hID && String(row.sID) === String(hID) ? 'highlight-row' : ''}">
                            ${this.COLS.map(c => `<td>${c === 'SpaceName' && row.PicNo ? `<a href="Details.html?sID=${row.sID}">${row[c]}</a>` : (row[c] || '')}</td>`).join('')}
                        </tr>`).join('');
                    document.getElementById('reset-btn').style.display = 'inline-block';
                },

                loadFromURL() {
                    const p = new URLSearchParams(window.location.search);
                    this.fetchData(p.get('keyword') || "", p.get('highlightID'));
                }
            };
            app.init();
        });
    </script>
</body>
</html>
