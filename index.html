<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Supabase æ¸¬è©¦ï¼šTblSpace æŸ¥è©¢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
        .main-content-wrapper { max-width: 100%; padding: 0 20px; margin: 20px auto; }
        h1 { font-size: 1.5rem; margin-bottom: 10px; padding: 5px 0; }
        #status { margin: 10px 0; color: #555; }
        #error { color: #b00020; margin: 10px 0; white-space: pre-wrap; }

        /* æœå°‹æ¬„ä½æ¨£å¼ */
        .search-bar { margin: 10px 0 20px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-bar label { width: 100%; font-weight: 600; }
        .search-bar label[for="campus-filter"], .search-bar label[for="building-filter"] { width: auto; font-weight: 500; margin-left: 10px; }
        .search-bar input, .search-bar select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; min-width: 200px; box-sizing: border-box; background-color: #fff; }
        .search-bar select { flex-grow: 0; min-width: 120px; cursor: pointer; }
        .search-bar button { padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: #fff; cursor: pointer; white-space: nowrap; transition: background-color 0.2s; }
        .search-bar button:hover { background-color: #0056b3; }

        /* æµ®å‹•è¡¨é ­æ¨£å¼ */
        .floating-header-container { position: fixed; top: 0; left: 0; right: 0; z-index: 100; overflow: hidden; background-color: #555; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); display: none; }
        .floating-header { width: 100%; min-width: 800px; border-collapse: collapse; table-layout: fixed; background: transparent; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { width: 100%; margin-top: 20px; border: none; overflow-x: auto; background: #fff; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08); }
        table { width: 100%; min-width: 800px; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 10px; border: none; font-size: 0.9rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* æ¬„ä½å¯¬åº¦ */
        th[data-col="SpaceName"], td[data-col="SpaceName"] { max-width: 250px; width: 250px; }
        th[data-col="CampusNo"], td[data-col="CampusNo"] { max-width: 150px; width: 150px; }
        th[data-col="SpaceNo"], td[data-col="SpaceNo"] { max-width: 120px; width: 120px; }

        #space-table > tbody > tr > td { border-bottom: 1px solid #eee; }
        #space-table > thead > tr > th, .floating-header th { background: #555; color: #fff !important; user-select: none; }

        /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå¼·åŒ–é«˜äº®èƒŒæ™¯æ¬Šé‡ --- */
        .highlight-row { background-color: #fff9c4 !important; font-weight: bold; }
        .highlight-row td { background-color: #fff9c4 !important; } /* ç¢ºä¿å–®å…ƒæ ¼èƒŒæ™¯ä¹Ÿè¢«è¦†è“‹ */

        td a { color: #007bff; text-decoration: none; font-weight: 500; }
        #back-to-top { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1000; width: 45px; height: 45px; line-height: 45px; text-align: center; background-color: rgba(0, 123, 255, 0.8); color: white; border-radius: 50%; text-decoration: none; }
    </style>
</head>
<body>

    <div class="floating-header-container" id="floating-header-container">
        <table class="floating-header" id="floating-header-table">
            <thead><tr id="floating-header-row"></tr></thead>
        </table>
    </div>

    <div class="main-content-wrapper">
        <h1>Supabase æ¸¬è©¦ï¼šTblSpace æŸ¥è©¢</h1>
        <div id="status">ç‹€æ…‹ï¼šæº–å‚™ä¸­...</div>
        <div id="error"></div>

        <div class="search-bar">
            <label for="search-input">è«‹è¼¸å…¥ç©ºé–“åç¨±ã€ç·¨è™Ÿæˆ–åœ–ç‰‡ç·¨è™Ÿï¼š</label>
            <input type="text" id="search-input" placeholder="ä¾‹å¦‚ï¼šæœƒè­°å®¤, A102" />
            <button id="search-btn">æœå°‹</button>
            <label for="campus-filter">æ ¡å€ç¯©é¸ï¼š</label>
            <select id="campus-filter"><option value="">-- æ‰€æœ‰æ ¡å€ --</option></select>
            <label for="building-filter">æ¨“æ£Ÿç¯©é¸ï¼š</label>
            <select id="building-filter"><option value="">-- æ‰€æœ‰æ¨“æ£Ÿ --</option></select>
            <button id="reset-btn" style="display:none;">é‡è¨­</button>
        </div>

        <div class="table-container" id="table-container" style="display:none;">
            <table id="space-table">
                <thead><tr id="table-head-row"></tr></thead>
                <tbody id="space-tbody"></tbody>
            </table>
        </div>
    </div>

    <a id="back-to-top" href="#" title="å›åˆ°é ‚ç«¯">ğŸ”</a>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const campusMapApp = {
                statusEl: document.getElementById("status"),
                errorEl: document.getElementById("error"),
                searchInput: document.getElementById("search-input"),
                searchBtn: document.getElementById("search-btn"),
                resetBtn: document.getElementById("reset-btn"),
                tableContainerEl: document.getElementById("table-container"),
                theadRow: document.getElementById("table-head-row"),
                tbody: document.getElementById("space-tbody"),
                spaceTableEl: document.getElementById("space-table"),
                floatingHeaderContainerEl: document.getElementById("floating-header-container"),
                floatingHeaderRow: document.getElementById("floating-header-row"),
                campusFilterEl: document.getElementById("campus-filter"),
                buildingFilterEl: document.getElementById("building-filter"),
                backToTopBtn: document.getElementById("back-to-top"),

                supabaseClient: null,
                currentData: [],
                sortConfig: { key: 'SpaceNo', direction: 1 },
                COLUMN_DISPLAY_NAMES: { 'SpaceNo': 'ç©ºé–“ç·¨è™Ÿ', 'SpaceName': 'ç©ºé–“åç¨±', 'CampusNo': 'æ ¡å€åç¨±', 'BuildingNo': 'æ‰€å±¬æ¨“æ£Ÿ', 'FloorNo': 'æ‰€åœ¨æ¨“å±¤', 'PicNo': 'åœ–ç‰‡ç·¨è™Ÿ' },
                CAMPUS_MAP: { '1': 'ä¸­å¤®æ ¡å€(æ ¡æœ¬éƒ¨)', '2': 'ä»‹ä»æ ¡å€(äººç¤¾é™¢)', '3': 'å»ºåœ‹æ ¡å€(æ…ˆç§‘å¤§)' },
                BUILDING_MAP: { 'A': 'A æ£Ÿ', 'B': 'B æ£Ÿ', 'C': 'C æ£Ÿ', 'D': 'D æ£Ÿ', 'E': 'E æ£Ÿ', 'F': 'F æ£Ÿ', 'G': 'G æ£Ÿ', 'H': 'H æ£Ÿ', 'I': 'I æ£Ÿ', 'J': 'J æ£Ÿ', 'K': 'K æ£Ÿ', 'L': 'L æ£Ÿ', 'M': 'M æ£Ÿ', 'N': 'N æ£Ÿ', 'O': 'O æ£Ÿ', 'P': 'P æ£Ÿ', 'Q': 'Q æ£Ÿ', 'R': 'R æ£Ÿ', 'S': 'S æ£Ÿ', 'T': 'T æ£Ÿ', 'U': 'U æ£Ÿ', 'V': 'V æ£Ÿ', 'W': 'W æ£Ÿ', 'X': 'X æ£Ÿ', 'Y': 'Y æ£Ÿ', 'Z': 'Z æ£Ÿ', '01': 'è¡Œæ”¿å¤§æ¨“' },

                init() {
                    if (typeof SUPABASE_URL === "undefined") return;
                    this.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.populateFilters();
                    this.addEventListeners();
                    this.loadFromURL();
                },

                addEventListeners() {
                    this.searchBtn.addEventListener("click", () => this.loadSpaces(this.searchInput.value));
                    this.resetBtn.addEventListener("click", () => {
                        window.location.href = window.location.pathname;
                    });
                    this.campusFilterEl.addEventListener("change", () => this.loadSpaces(this.searchInput.value));
                    this.buildingFilterEl.addEventListener("change", () => this.loadSpaces(this.searchInput.value));
                    
                    const sortHandler = (e) => {
                        const th = e.target.closest('th');
                        if (th && th.dataset.col === 'SpaceNo') {
                            const params = new URLSearchParams(window.location.search);
                            this.handleSort(th.dataset.col, params.get('highlightID'));
                        }
                    };
                    this.theadRow.addEventListener('click', sortHandler);
                    this.floatingHeaderRow.addEventListener('click', sortHandler);
                    window.addEventListener('scroll', () => { this.handleFloatingHeader(); this.handleScroll(); });
                    this.backToTopBtn.addEventListener("click", (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
                },

                handleScroll() { this.backToTopBtn.style.display = window.scrollY > 300 ? 'block' : 'none'; },

                populateFilters() {
                    let campusOptions = '<option value="">-- æ‰€æœ‰æ ¡å€ --</option>';
                    Object.entries(this.CAMPUS_MAP).forEach(([k, v]) => campusOptions += `<option value="${k}">${v}</option>`);
                    this.campusFilterEl.innerHTML = campusOptions;

                    let buildingOptions = '<option value="">-- æ‰€æœ‰æ¨“æ£Ÿ --</option>';
                    Object.entries(this.BUILDING_MAP).forEach(([k, v]) => buildingOptions += `<option value="${k}">${v}</option>`);
                    this.buildingFilterEl.innerHTML = buildingOptions;
                },

                async loadSpaces(keyword = "", limitCount = 0, highlightID = null) {
                    this.statusEl.textContent = "ç‹€æ…‹: è³‡æ–™è®€å–ä¸­...";
                    const selectedCampus = this.campusFilterEl.value;
                    const selectedBuilding = this.buildingFilterEl.value;
                    const cleanKeyword = keyword.trim();

                    // æ›´æ–°ç¶²å€åƒæ•¸
                    const url = new URL(window.location);
                    if (cleanKeyword) url.searchParams.set('keyword', cleanKeyword); else url.searchParams.delete('keyword');
                    if (selectedCampus) url.searchParams.set('campus', selectedCampus); else url.searchParams.delete('campus');
                    if (selectedBuilding) url.searchParams.set('building', selectedBuilding); else url.searchParams.delete('building');
                    if (highlightID) url.searchParams.set('highlightID', highlightID);
                    window.history.replaceState({}, '', url);

                    let query = this.supabaseClient.from("TblSpace").select('sID,SpaceNo,SpaceName,CampusNo,BuildingNo,FloorNo,PicNo');

                    if (cleanKeyword) query = query.or(`SpaceName.ilike.%${cleanKeyword}%,SpaceNo.ilike.%${cleanKeyword}%,PicNo.ilike.%${cleanKeyword}%`);
                    if (selectedCampus) query = query.eq('CampusNo', selectedCampus);
                    if (selectedBuilding) query = query.or(`BuildingNo.eq.${selectedBuilding},BuildingNo.eq.2${selectedBuilding}`);

                    query = query.limit(5000);

                    try {
                        const { data, error } = await query;
                        if (error) throw error;
                        this.currentData = data || [];
                        this.statusEl.textContent = `ç‹€æ…‹: è®€å–æˆåŠŸï¼Œå…± ${this.currentData.length} ç­†`;
                        // è¼‰å…¥å®Œç•¢å¾ŒåŸ·è¡Œæ’åºèˆ‡é«˜äº®ç½®é ‚
                        this.handleSort('SpaceNo', highlightID); 
                    } catch (error) {
                        this.statusEl.textContent = "ç‹€æ…‹: è®€å–å¤±æ•—";
                        this.errorEl.textContent = `éŒ¯èª¤: ${error.message}`;
                    }
                },

                handleSort(key, highlightID = null) {
                    if (key !== 'SpaceNo') return;
                    
                    // 1. åŸ·è¡ŒåŸºç¤æ’åº
                    this.currentData.sort((a, b) => {
                        return a[key].localeCompare(b[key], undefined, {numeric: true, sensitivity: 'base'}) * this.sortConfig.direction;
                    });

                    // 2. æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœå­˜åœ¨ highlightIDï¼Œå°‡è©²ç­†è³‡æ–™æŠ½å‡ºä¾†æ”¾åˆ°æœ€å‰é¢
                    if (highlightID) {
                        const idx = this.currentData.findIndex(item => String(item.sID) === String(highlightID));
                        if (idx > -1) {
                            const highlightedItem = this.currentData.splice(idx, 1)[0];
                            this.currentData.unshift(highlightedItem);
                        }
                    }

                    this.renderTable(this.currentData, highlightID);
                },

                renderTable(data, highlightID = null) {
                    this.theadRow.innerHTML = ""; this.tbody.innerHTML = "";
                    if (!data || data.length === 0) { this.tableContainerEl.style.display = "none"; return; }
                    this.tableContainerEl.style.display = "block";

                    const cols = ['SpaceNo', 'SpaceName', 'CampusNo', 'BuildingNo', 'FloorNo', 'PicNo'];
                    
                    // Render Header
                    const headerHTML = cols.map(col => `<th data-col="${col}">${this.COLUMN_DISPLAY_NAMES[col]}</th>`).join('');
                    this.theadRow.innerHTML = headerHTML;
                    this.floatingHeaderRow.innerHTML = headerHTML;

                    // Render Body
                    this.tbody.innerHTML = data.map(row => {
                        // æ ¸å¿ƒä¿®æ”¹ï¼šç¢ºä¿ sID æ¯”å°æ™‚è½‰ç‚ºå­—ä¸²
                        const isHigh = (highlightID && String(row.sID) === String(highlightID)) ? 'class="highlight-row"' : '';
                        return `<tr ${isHigh}>${cols.map(col => {
                            let val = row[col] || "";
                            if (col === 'CampusNo') val = this.CAMPUS_MAP[val] || val;
                            if (col === 'BuildingNo') val = this.BUILDING_MAP[val] || val;
                            if (col === 'FloorNo' && val) val = `${val} æ¨“`;
                            if (col === 'SpaceName' && row.PicNo) {
                                const href = `Details.html?sID=${row.sID}&keyword=${encodeURIComponent(this.searchInput.value)}&campus=${this.campusFilterEl.value}&building=${this.buildingFilterEl.value}`;
                                return `<td><a href="${href}">${val}</a></td>`;
                            }
                            return `<td>${val}</td>`;
                        }).join('')}</tr>`;
                    }).join('');

                    this.syncHeaderWidths();
                    this.resetBtn.style.display = 'inline-block';
                },

                syncHeaderWidths() {
                    const ths = this.theadRow.children;
                    const fths = this.floatingHeaderRow.children;
                    for (let i = 0; i < ths.length; i++) {
                        if (fths[i]) fths[i].style.width = window.getComputedStyle(ths[i]).width;
                    }
                    this.floatingHeaderContainerEl.style.width = `${this.tableContainerEl.offsetWidth}px`;
                },

                handleFloatingHeader() {
                    const rect = this.spaceTableEl.getBoundingClientRect();
                    this.floatingHeaderContainerEl.style.display = (rect.top < 0 && rect.bottom > 50) ? "block" : "none";
                },

                loadFromURL() {
                    const p = new URLSearchParams(window.location.search);
                    const hID = p.get('highlightID');
                    if (p.get('campus')) this.campusFilterEl.value = p.get('campus');
                    if (p.get('building')) this.buildingFilterEl.value = p.get('building');
                    this.searchInput.value = p.get('keyword') || "";
                    this.loadSpaces(this.searchInput.value, 0, hID);
                }
            };
            campusMapApp.init();
        });
    </script>
</body>
</html>
