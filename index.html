<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>æ ¡åœ’å°‹è·¯</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
        .main-content-wrapper { max-width: 100%; padding: 0 20px; margin: 20px auto; }
        
        /* æ¨™é¡Œèˆ‡çµ±è¨ˆå€å¡Š */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-bar h1 { font-size: 1.5rem; margin: 0; color: #333; }

        /* çµ±è¨ˆæ•¸æ“šæ¨™ç±¤çµ„ */
        .stats-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .stat-tag {
            background-color: #fff;
            color: #555;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .online-dot {
            width: 8px; height: 8px; background-color: #28a745;
            border-radius: 50%; margin-right: 6px;
            box-shadow: 0 0 5px #28a745;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* æœå°‹åˆ— */
        .search-bar { margin: 10px 0 20px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-bar select, .search-bar input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; }
        .search-bar input { flex-grow: 1; min-width: 200px; }
        .search-bar button { padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: #fff; cursor: pointer; transition: 0.2s; }
        .search-bar button:hover { background-color: #0056b3; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { width: 100%; overflow-x: auto; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); border-radius: 4px; }
        table { width: 100%; min-width: 800px; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 12px 10px; font-size: 0.9rem; text-align: center; border-bottom: 1px solid #eee; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { cursor: pointer; background: #555; color: #fff; position: relative; }
        
        .sort-indicator { display: inline-flex; flex-direction: column; vertical-align: middle; margin-left: 5px; line-height: 0.7; }
        .sort-arrow { color: rgba(255, 255, 255, 0.2); font-size: 0.7rem; }
        .active-asc .arrow-up { color: #8ac0ff !important; }
        .active-desc .arrow-down { color: #8ac0ff !important; }

        .highlight-row, .highlight-row td { background-color: #fff9c4 !important; font-weight: bold; }
        td a { color: #007bff; text-decoration: none; font-weight: 600; }

        .floating-header-container { position: fixed; top: 0; z-index: 100; overflow: hidden; background-color: #555; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #back-to-top { display: none; position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; background: #007bff; color: #fff; border-radius: 50%; text-align: center; line-height: 45px; text-decoration: none; z-index: 1000; }
    </style>
</head>
<body>

    <div class="main-content-wrapper">
        <div class="header-bar">
            <h1>æ ¡åœ’å°‹è·¯æ…ˆå¤§ç©ºé–“æŸ¥è©¢å¹³å°</h1>
            <div class="stats-group">
                <div class="stat-tag"><span class="online-dot"></span>åœ¨ç·šäººæ•¸ï¼š<span id="online-count">1</span></div>
                <div class="stat-tag">ç€è¦½æ¬¡æ•¸ï¼š<span id="visit-total">...</span></div>
            </div>
        </div>

        <div id="status">ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</div>
        <div id="error" style="color: red; margin: 10px 0;"></div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="æœå°‹åç¨±ã€ç·¨è™Ÿ..." />
            <button id="search-btn">æœå°‹</button>
            <select id="campus-filter"></select>
            <select id="building-filter"></select>
            <button id="reset-btn" style="display:none; background-color: #6c757d;">é‡è¨­</button>
        </div>

        <div class="table-container" id="table-container">
            <table id="space-table">
                <thead><tr id="table-head-row"></tr></thead>
                <tbody id="space-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="floating-header-container" id="floating-header-container">
        <table id="floating-header-table"><thead><tr id="floating-header-row"></tr></thead></table>
    </div>
    
    <a id="back-to-top" href="#">ğŸ”</a>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BUILDING_NAMES_MAP = {
                "1": { "A": "å’Œæ•¬æ¨“ A æ£Ÿ", "B": "å’Œæ•¬æ¨“ B æ£Ÿ", "C": "å’Œæ•¬æ¨“ C æ£Ÿ", "D": "å‹¤è€•æ¨“ D æ£Ÿ", "E": "å‹¤è€•æ¨“ E æ£Ÿ", "F": "å¤§æ¨æ¨“ F æ£Ÿ", "H": "ç¦ç”°æ¨“ H æ£Ÿ", "L": "å¤§æ„›æ¨“ L æ£Ÿ", "T": "å¤§å–œé¤¨ L æ£Ÿ" },
                "2": { "A": "åˆå¿ƒæ¨“ 2A æ£Ÿ", "B": "æ–‡å¿ƒæ¨“ 2B æ£Ÿ", "C": "ç«‹å¿ƒæ¨“ 2C æ£Ÿ", "D": "çŸ¥å¿ƒæ¨“ 2D æ£Ÿ", "E": "æ˜å¿ƒæ¨“ 2E æ£Ÿ", "G": "é«”è‚²é¤¨ 2A æ£Ÿ", "H": "æ´»å‹•ä¸­å¿ƒ 2A æ£Ÿ" }
            };

            const app = {
                supabase: null,
                currentData: [],
                sortCol: 'SpaceNo', sortDir: 1,
                CAMPUS_MAP: { '1': 'ä¸­å¤®æ ¡å€', '2': 'ä»‹ä»æ ¡å€', '3': 'å»ºåœ‹æ ¡å€' },
                COLS: ['SpaceNo', 'SpaceName', 'CampusNo', 'BuildingNo', 'FloorNo', 'PicNo'],
                COL_NAMES: { 'SpaceNo': 'ç©ºé–“ç·¨è™Ÿ', 'SpaceName': 'ç©ºé–“åç¨±', 'CampusNo': 'æ ¡å€', 'BuildingNo': 'æ¨“æ£Ÿ', 'FloorNo': 'æ¨“å±¤', 'PicNo': 'åœ–ç‰‡ç·¨è™Ÿ' },

                async init() {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.setupStats();
                    this.setupRealtime();
                    this.renderFilters();
                    this.bindEvents();
                    this.loadFromURL();
                },

                // 1. åœ¨ç·šäººæ•¸ (Presence)
                async setupRealtime() {
                    const channel = this.supabase.channel('online_tracking', {
                        config: { presence: { key: 'user' } }
                    });
                    channel
                        .on('presence', { event: 'sync' }, () => {
                            const state = channel.presenceState();
                            document.getElementById('online-count').textContent = Object.keys(state).length;
                        })
                        .subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') await channel.track({ online_at: new Date().toISOString() });
                        });
                },

                // 2. çµ±è¨ˆæ•¸æ“š (å„ªåŒ–ç‰ˆï¼šåªé¡¯ç¤ºç¸½ç€è¦½æ¬¡æ•¸)
                async setupStats() {
                    try {
                        const ipRes = await fetch('https://api.ipify.org?format=json');
                        const { ip } = await ipRes.json();
                        const today = new Date().toISOString().split('T')[0];

                        // å…ˆæª¢æŸ¥ä»Šå¤©æœ‰æ²’æœ‰é€™ç­† IP
                        const { data: existing } = await this.supabase
                            .from('daily_page_views')
                            .select('id')
                            .eq('ip_address', ip)
                            .eq('view_date', today)
                            .maybeSingle();

                        if (!existing) {
                            await this.supabase.from('daily_page_views').insert([{ ip_address: ip }]);
                        }

                        // æŠ“å–å…¨è¡¨ç­†æ•¸ä¾†æ›´æ–°ã€Œç€è¦½æ¬¡æ•¸ã€
                        const { count, error } = await this.supabase
                            .from('daily_page_views')
                            .select('*', { count: 'exact', head: true });
                        
                        if (!error) {
                            document.getElementById('visit-total').textContent = count;
                        }
                    } catch (err) { console.error('Stats Error:', err); }
                },

                renderFilters() {
                    let cOpt = '<option value="">-- æ ¡å€ --</option>';
                    Object.entries(this.CAMPUS_MAP).forEach(([k, v]) => cOpt += `<option value="${k}">${v}</option>`);
                    document.getElementById('campus-filter').innerHTML = cOpt;
                    let bOpt = '<option value="">-- æ¨“æ£Ÿ --</option>';
                    for (let i = 65; i <= 90; i++) bOpt += `<option value="${String.fromCharCode(i)}">${String.fromCharCode(i)} æ£Ÿ</option>`;
                    document.getElementById('building-filter').innerHTML = bOpt;
                },

                bindEvents() {
                    document.getElementById('search-btn').onclick = () => this.fetchData(document.getElementById('search-input').value);
                    document.getElementById('reset-btn').onclick = () => window.location.href = window.location.pathname;
                    document.getElementById('campus-filter').onchange = () => this.fetchData(document.getElementById('search-input').value);
                    document.getElementById('building-filter').onchange = () => this.fetchData(document.getElementById('search-input').value);

                    const handleHeaderClick = (e) => {
                        const th = e.target.closest('th');
                        if (th) {
                            this.sortDir = (this.sortCol === th.dataset.col) ? this.sortDir * -1 : 1;
                            this.sortCol = th.dataset.col;
                            this.sortAndRender();
                        }
                    };
                    document.getElementById("table-head-row").onclick = handleHeaderClick;
                    document.getElementById("floating-header-row").onclick = handleHeaderClick;

                    window.onscroll = () => {
                        const table = document.getElementById("space-table");
                        const floating = document.getElementById("floating-header-container");
                        const rect = table.getBoundingClientRect();
                        const container = document.getElementById("table-container");
                        if (rect.top < 0 && rect.bottom > 100) {
                            floating.style.display = "block";
                            floating.style.width = container.offsetWidth + "px";
                            floating.style.left = container.getBoundingClientRect().left + "px";
                        } else {
                            floating.style.display = "none";
                        }
                        document.getElementById("back-to-top").style.display = window.scrollY > 300 ? "block" : "none";
                    };
                },

                async fetchData(kw = "", hID = null) {
                    document.getElementById('status').textContent = "ç‹€æ…‹: æª¢ç´¢ä¸­...";
                    const camp = document.getElementById('campus-filter').value;
                    const bld = document.getElementById('building-filter').value;

                    let q = this.supabase.from("TblSpace").select('*');
                    if (kw) q = q.or(`SpaceName.ilike.%${kw}%,SpaceNo.ilike.%${kw}%`);
                    if (camp) q = q.eq('CampusNo', camp);
                    if (bld) q = q.or(`BuildingNo.eq.${bld},BuildingNo.eq.2${bld}`);

                    const { data, error } = await q.limit(1000);
                    if (error) { document.getElementById('error').textContent = error.message; return; }
                    this.currentData = data || [];
                    document.getElementById('status').textContent = `ç‹€æ…‹: æ‰¾åˆ° ${this.currentData.length} ç­†è³‡æ–™`;
                    this.sortAndRender(hID);
                },

                sortAndRender(hID) {
                    this.currentData.sort((a, b) => {
                        let vA = String(a[this.sortCol] || "");
                        let vB = String(b[this.sortCol] || "");
                        return vA.localeCompare(vB, undefined, { numeric: true }) * this.sortDir;
                    });
                    this.render(hID);
                },

                render(hID) {
                    const hHTML = this.COLS.map(c => `
                        <th data-col="${c}">${this.COL_NAMES[c]}
                            <span class="sort-indicator ${this.sortCol === c ? (this.sortDir === 1 ? 'active-asc' : 'active-desc') : ''}">
                                <span class="sort-arrow arrow-up">â–´</span><span class="sort-arrow arrow-down">â–¾</span>
                            </span>
                        </th>`).join('');
                    document.getElementById("table-head-row").innerHTML = hHTML;
                    document.getElementById("floating-header-row").innerHTML = hHTML;

                    document.getElementById("space-tbody").innerHTML = this.currentData.map(row => `
                        <tr class="${hID && String(row.sID) === String(hID) ? 'highlight-row' : ''}">
                            ${this.COLS.map(c => {
                                let v = row[c] || "";
                                if (c === 'CampusNo') v = this.CAMPUS_MAP[v] || v;
                                if (c === 'BuildingNo') {
                                    const campusMap = BUILDING_NAMES_MAP[row.CampusNo];
                                    if (campusMap) {
                                        const cleanNo = v.toString().replace(/^2/, '');
                                        v = campusMap[v] || campusMap[cleanNo] || `${v} æ£Ÿ`;
                                    }
                                }
                                if (c === 'SpaceName' && row.PicNo) return `<td><a href="Details.html?sID=${row.sID}">${v}</a></td>`;
                                return `<td>${v}</td>`;
                            }).join('')}
                        </tr>`).join('');
                    document.getElementById('reset-btn').style.display = 'inline-block';
                },

                loadFromURL() {
                    const p = new URLSearchParams(window.location.search);
                    document.getElementById('search-input').value = p.get('keyword') || "";
                    this.fetchData(p.get('keyword') || "", p.get('highlightID'));
                }
            };
            app.init();
        });
    </script>
</body>
</html>
