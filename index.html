<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Supabase Á©∫ÈñìÊü•Ë©¢Á≥ªÁµ± (Ê†°ÂçÄÊ®ìÊ£üÂÑ™ÂåñÁâà)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
        .main-content-wrapper { max-width: 100%; padding: 0 20px; margin: 20px auto; }
        h1 { font-size: 1.5rem; margin-bottom: 10px; }
        #status { margin: 10px 0; color: #555; font-size: 0.9rem; }
        #error { color: #b00020; margin: 10px 0; }
        .search-bar { margin: 10px 0 20px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-bar label { font-weight: 600; width: 100%; }
        .search-bar select, .search-bar input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; background: #fff; }
        .search-bar input { flex-grow: 1; min-width: 200px; }
        .search-bar button { padding: 8px 15px; border-radius: 4px; border: none; background-color: #007bff; color: #fff; cursor: pointer; }
        .search-bar button:hover { background-color: #0056b3; }
        .floating-header-container { position: fixed; top: 0; z-index: 100; overflow: hidden; background-color: #555; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: none; }
        .table-container { width: 100%; margin-top: 20px; overflow-x: auto; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        table { width: 100%; min-width: 800px; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 12px 10px; font-size: 0.9rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th { cursor: pointer; position: relative; transition: background 0.2s; }
        th:hover { background-color: #666; }
        th[data-col="SpaceName"], td[data-col="SpaceName"] { width: 250px; }
        th[data-col="CampusNo"], td[data-col="CampusNo"] { width: 150px; }
        th[data-col="SpaceNo"], td[data-col="SpaceNo"] { width: 130px; }
        thead tr, .floating-header-container tr { background: #555; color: #fff; }
        tbody tr { border-bottom: 1px solid #eee; }
        .sort-indicator { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin-left: 6px; line-height: 0.7; }
        .sort-arrow { color: rgba(255, 255, 255, 0.2); font-size: 0.9rem; }
        .sort-indicator.active-asc .arrow-up { color: #8ac0ff; }
        .sort-indicator.active-desc .arrow-down { color: #8ac0ff; }
        .highlight-row, .highlight-row td { background-color: #fff9c4 !important; font-weight: bold; }
        td a { color: #007bff; text-decoration: none; font-weight: 500; }
        #back-to-top { display: none; position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px; background: rgba(0,123,255,0.8); color: #fff; border-radius: 50%; text-align: center; line-height: 45px; text-decoration: none; }
    </style>
</head>
<body>

    <div class="floating-header-container" id="floating-header-container">
        <table id="floating-header-table">
            <thead><tr id="floating-header-row"></tr></thead>
        </table>
    </div>

    <div class="main-content-wrapper">
        <h1>Á©∫ÈñìË≥áË®äÊü•Ë©¢Á≥ªÁµ±</h1>
        <div id="status">ÁãÄÊÖãÔºöËºâÂÖ•‰∏≠...</div>
        <div id="error"></div>

        <div class="search-bar">
            <label>Âø´ÈÄüÊêúÂ∞ãÔºö</label>
            <input type="text" id="search-input" placeholder="Ëº∏ÂÖ•ÂêçÁ®±„ÄÅÁ∑®Ëôü..." />
            <button id="search-btn">ÊêúÂ∞ã</button>
            <select id="campus-filter"></select>
            <select id="building-filter"></select>
            <button id="reset-btn" style="display:none;">ÈáçË®≠</button>
        </div>

        <div class="table-container" id="table-container">
            <table id="space-table">
                <thead><tr id="table-head-row"></tr></thead>
                <tbody id="space-tbody"></tbody>
            </table>
        </div>
    </div>

    <a id="back-to-top" href="#">üîù</a>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. ÂÆöÁæ©Ê®ìÊ£üÂêçÁ®±Êò†Â∞ÑË°® (‰Ω†ÂèØ‰ª•Ê†πÊìöÈúÄË¶ÅÊåÅÁ∫åÂ¢ûÂä†)
            const BUILDING_NAMES_MAP = {
                "1": { // ‰∏≠Â§ÆÊ†°ÂçÄ
                    "A": "ÂíåÊï¨Ê®ì A Ê£ü",
                    "B": "ÂíåÊï¨Ê®ì B Ê£ü",
                    "C": "ÂíåÊï¨Ê®ì C Ê£ü",
                    "D": "Âã§ËÄïÊ®ì D Ê£ü",
                    "E": "Âã§ËÄïÊ®ì E Ê£ü",
                    "F": "Â§ßÊç®Ê®ì F Ê£ü",
                    "H": "Á¶èÁî∞Ê®ì H Ê£ü",
                    "L": "Â§ßÊÑõÊ®ì L Ê£ü",
                    "T": "Â§ßÂñúÈ§® L Ê£ü"
                },
                "2": { // ‰ªã‰ªÅÊ†°ÂçÄ
                    "A": "ÂêàÂøÉÊ®ì 2A Ê£ü",
                    "B": "ÊñáÂøÉÊ®ì 2B Ê£ü",
                    "C": "Á´ãÂøÉÊ®ì 2C Ê£ü",
                    "D": "Áü•ÂøÉÊ®ì 2D Ê£ü",
                    "E": "ÊòéÂøÉÊ®ì 2E Ê£ü",
                    "G": "È´îËÇ≤È§® 2A Ê£ü",
                    "H": "Ê¥ªÂãï‰∏≠ÂøÉ 2A Ê£ü"
                }            
            };

            const getBuildingDisplayName = (campusNo, buildingNo) => {
                const campusMap = BUILDING_NAMES_MAP[campusNo];
                if (campusMap) {
                    // ÂòóË©¶ÊäìÂèñ A, B, C ÊàñÂéüÊú¨ÁöÑÁ∑®Ëôü
                    const cleanNo = buildingNo.toString().replace(/^2/, ''); // ‰ªã‰ªÅÊ†°ÂçÄÂÖºÂÆπ
                    if (campusMap[buildingNo]) return campusMap[buildingNo];
                    if (campusMap[cleanNo]) return campusMap[cleanNo];
                }
                return `${buildingNo} Ê£ü`;
            };

            const app = {
                statusEl: document.getElementById("status"),
                errorEl: document.getElementById("error"),
                searchInput: document.getElementById("search-input"),
                searchBtn: document.getElementById("search-btn"),
                resetBtn: document.getElementById("reset-btn"),
                tableContainer: document.getElementById("table-container"),
                tbody: document.getElementById("space-tbody"),
                floatingHeaderContainer: document.getElementById("floating-header-container"),
                floatingHeaderTable: document.getElementById("floating-header-table"),
                campusFilter: document.getElementById("campus-filter"),
                buildingFilter: document.getElementById("building-filter"),

                supabase: null,
                currentData: [],
                sortCol: 'SpaceNo', 
                sortDir: 1, 
                CAMPUS_MAP: { '1': '‰∏≠Â§ÆÊ†°ÂçÄ', '2': '‰ªã‰ªÅÊ†°ÂçÄ', '3': 'Âª∫ÂúãÊ†°ÂçÄ' },
                COLS: ['SpaceNo', 'SpaceName', 'CampusNo', 'BuildingNo', 'FloorNo', 'PicNo'],
                COL_NAMES: { 'SpaceNo': 'Á©∫ÈñìÁ∑®Ëôü', 'SpaceName': 'Á©∫ÈñìÂêçÁ®±', 'CampusNo': 'Ê†°ÂçÄ', 'BuildingNo': 'Ê®ìÊ£ü', 'FloorNo': 'Ê®ìÂ±§', 'PicNo': 'ÂúñÁâáÁ∑®Ëôü' },

                init() {
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    this.renderFilters();
                    this.bindEvents();
                    this.loadFromURL();
                },

                renderFilters() {
                    let cOpt = '<option value="">-- Ê†°ÂçÄ --</option>';
                    Object.entries(this.CAMPUS_MAP).forEach(([k, v]) => cOpt += `<option value="${k}">${v}</option>`);
                    this.campusFilter.innerHTML = cOpt;

                    // ÁØ©ÈÅ∏ÈÅ∏ÂñÆÈ°ØÁ§∫ A-Z
                    let bOpt = '<option value="">-- Ê®ìÊ£ü --</option>';
                    for (let i = 65; i <= 90; i++) {
                        const letter = String.fromCharCode(i);
                        bOpt += `<option value="${letter}">${letter} Ê£ü</option>`;
                    }
                    this.buildingFilter.innerHTML = bOpt;
                },

                bindEvents() {
                    this.searchBtn.onclick = () => this.fetchData(this.searchInput.value);
                    this.resetBtn.onclick = () => window.location.href = window.location.pathname;
                    this.campusFilter.onchange = () => this.fetchData(this.searchInput.value);
                    this.buildingFilter.onchange = () => this.fetchData(this.searchInput.value);
                    this.searchInput.onkeyup = (e) => e.key === 'Enter' && this.fetchData(this.searchInput.value);

                    const handleHeaderClick = (e) => {
                        const th = e.target.closest('th');
                        if (th) {
                            const col = th.dataset.col;
                            if (this.sortCol === col) this.sortDir *= -1;
                            else { this.sortCol = col; this.sortDir = 1; }
                            this.sortAndRender(new URLSearchParams(window.location.search).get('highlightID'));
                        }
                    };
                    document.getElementById("table-head-row").onclick = handleHeaderClick;
                    document.getElementById("floating-header-row").onclick = handleHeaderClick;
                    window.onscroll = () => this.syncHeaderPos();
                    this.tableContainer.onscroll = () => this.syncHeaderScroll();
                },

                async fetchData(kw = "", hID = null) {
                    this.statusEl.textContent = "ÁãÄÊÖã: Ê™¢Á¥¢‰∏≠...";
                    const camp = this.campusFilter.value;
                    const bld = this.buildingFilter.value;
                    const url = new URL(window.location);
                    if(kw) url.searchParams.set('keyword', kw); else url.searchParams.delete('keyword');
                    if(camp) url.searchParams.set('campus', camp); else url.searchParams.delete('campus');
                    if(bld) url.searchParams.set('building', bld); else url.searchParams.delete('building');
                    if(hID) url.searchParams.set('highlightID', hID);
                    window.history.replaceState({}, '', url);

                    let q = this.supabase.from("TblSpace").select('*');
                    if (kw) q = q.or(`SpaceName.ilike.%${kw}%,SpaceNo.ilike.%${kw}%`);
                    if (camp) q = q.eq('CampusNo', camp);
                    if (bld) q = q.or(`BuildingNo.eq.${bld},BuildingNo.eq.2${bld}`);

                    const { data, error } = await q.limit(1000);
                    if (error) { this.errorEl.textContent = error.message; return; }
                    this.currentData = data || [];
                    this.statusEl.textContent = `ÁãÄÊÖã: ÊâæÂà∞ ${this.currentData.length} Á≠ÜË≥áÊñô`;
                    this.sortAndRender(hID || url.searchParams.get('highlightID'));
                },

                sortAndRender(hID) {
                    this.currentData.sort((a, b) => {
                        let valA = (a[this.sortCol] || "").toString();
                        let valB = (b[this.sortCol] || "").toString();
                        return valA.localeCompare(valB, undefined, { numeric: true }) * this.sortDir;
                    });
                    if (hID) {
                        const idx = this.currentData.findIndex(i => String(i.sID) === String(hID));
                        if (idx > -1) {
                            const item = this.currentData.splice(idx, 1)[0];
                            this.currentData.unshift(item);
                        }
                    }
                    this.render(hID);
                },

                render(hID) {
                    const hHTML = this.COLS.map(c => {
                        let activeClass = (this.sortCol === c) ? (this.sortDir === 1 ? 'active-asc' : 'active-desc') : "";
                        const indicator = `<span class="sort-indicator ${activeClass}"><span class="sort-arrow arrow-up">‚ñ¥</span><span class="sort-arrow arrow-down">‚ñæ</span></span>`;
                        return `<th data-col="${c}">${this.COL_NAMES[c]}${indicator}</th>`;
                    }).join('');
                    document.getElementById("table-head-row").innerHTML = hHTML;
                    document.getElementById("floating-header-row").innerHTML = hHTML;

                    const kw = this.searchInput.value;
                    const cp = this.campusFilter.value;
                    const bd = this.buildingFilter.value;

                    this.tbody.innerHTML = this.currentData.map(row => {
                        const isH = (hID && String(row.sID) === String(hID)) ? 'class="highlight-row"' : '';
                        return `<tr ${isH}>${this.COLS.map(c => {
                            let v = row[c] || "";
                            if (c === 'CampusNo') v = this.CAMPUS_MAP[v] || v;
                            
                            // ÈóúÈçµ‰øÆÊîπÔºöÈ°ØÁ§∫Ê®ìÊ£üÂêçÁ®±
                            if (c === 'BuildingNo') {
                                v = getBuildingDisplayName(row.CampusNo, v);
                            }
                            
                            if (c === 'FloorNo' && v) v = `${v} Ê®ì`;
                            if (c === 'SpaceName' && row.PicNo) {
                                const link = `Details.html?sID=${row.sID}&highlightID=${row.sID}&keyword=${encodeURIComponent(kw)}&campus=${cp}&building=${bd}`;
                                return `<td><a href="${link}">${v}</a></td>`;
                            }
                            return `<td>${v}</td>`;
                        }).join('')}</tr>`;
                    }).join('');
                    this.resetBtn.style.display = 'inline-block';
                    this.syncHeaderWidths();
                },

                syncHeaderWidths() {
                    const ths = document.getElementById("table-head-row").children;
                    const fths = document.getElementById("floating-header-row").children;
                    if (!ths.length) return;
                    for (let i = 0; i < ths.length; i++) {
                        fths[i].style.width = getComputedStyle(ths[i]).width;
                        fths[i].style.minWidth = getComputedStyle(ths[i]).width;
                    }
                },

                syncHeaderPos() {
                    const rect = document.getElementById("space-table").getBoundingClientRect();
                    const containerRect = this.tableContainer.getBoundingClientRect();
                    if (rect.top < 0 && rect.bottom > 100) {
                        this.floatingHeaderContainer.style.display = "block";
                        this.floatingHeaderContainer.style.left = `${containerRect.left}px`;
                        this.floatingHeaderContainer.style.width = `${containerRect.width}px`;
                        this.syncHeaderScroll();
                    } else { this.floatingHeaderContainer.style.display = "none"; }
                    document.getElementById("back-to-top").style.display = window.scrollY > 300 ? "block" : "none";
                },

                syncHeaderScroll() {
                    this.floatingHeaderTable.style.marginLeft = `-${this.tableContainer.scrollLeft}px`;
                },

                loadFromURL() {
                    const p = new URLSearchParams(window.location.search);
                    this.searchInput.value = p.get('keyword') || "";
                    this.campusFilter.value = p.get('campus') || "";
                    this.buildingFilter.value = p.get('building') || "";
                    this.fetchData(this.searchInput.value, p.get('highlightID'));
                }
            };
            app.init();
        });
    </script>
</body>
</html>
